---
title: 文件系统
typora-root-url: ../
date: 2020-12-31 09:32:08
tags:
 - 文件管理
categories:
 - [操作系统,现代操作系统]
---

本文简单介绍一下文件系统的作用，用户眼中的文件系统，最后再介绍一些关键部分的实现

<!--more-->

**文件**是进程创建的信息逻辑单元，是对磁盘的抽象，可以理解为每一个文件就是一个地址空间，而操作系统处理文件的部分就称为**文件系统。**

[TOC]



# 文件系统表现形式

文件系统表现形式是用户所关心的，在用户眼中主要是文件和目录。

## 文件

用户需要对文件进行命名、修改等操作。

一般**文件命名**采用`文件名+.扩展名`的格式。扩展名可以是一种约定，表明文件的一些信息；windows的进程可以在操作系统中注册扩展名，于是双击文件的时候，拥有该扩展名的进程就会启动并运行该文件。

文件可以有多种**构造（组成）方式**，最常见的是无结构的**字节序列**，其灵活性高，可以添加任何内容，用在多种操作系统；还有一种是一颗**记录树**，每个记录长度不一，但固定位置上有一**键**字段，这颗树按键排序，构成文件，这样的文件易于查找键，用于处理数据的大型计算机。

文件有不同类型，常见的是**普通文件**和**目录**。前者是包含用户信息的文件，可在分为**ASCII文件**和**二进制文件**。后者是管理文件系统结构的系统文件。

当访问文件内容时，可以**顺序访问**，从头按顺序读取文件全部字节或记录；也可以**随机访问文件**，以任意次序读取。一般后者为很多应用程序需要，可以通过给出开始读文件的位置或者设置当前位置实现从某处开始读取文件

最后介绍一下**文件属性**，其是指文件相关的信息，比如保护、口令、创建者、所有者、创建日期、标志位、文件大小、修改时间等，这也称为**元数据**

## 目录

目录用来记录文件的位置，前面文件类型中也提到目录，很多系统中目录本身也是文件。

从宏观层次上来说，目录系统有一个目录包含所有文件的**根目录、一级目录系统**，但只用于简单的特殊应，。也有**层次结构**即一颗目录树的形式，现在，几乎所有操作系统都是这样组织的。

当使用目录树组织文件系统时，需要有路径名的概念。路径名分为**绝对路径名**和**相对路径名**，前者常用于本地文件管理，后者更方便，而且是以工作目录为基准的。在我们上次GitHub项目要显示图片、或者是Hexo搭建博客解决图片显示问题时，就很可能用到相对路径。

对于路径需要使用到**分隔符**分割不同子目录，在windows中是“\”,在Linux中是"/",如果路径名的第一个字符是分隔符，其为绝对路径。最后有两个特殊目录项`.`和`..`,前者表示当前目录，后者表示父目录。我在设置Hexo和Typora图片保存路径时，就用到了`typora-root-url: ../`这样一条途径，表明图片应该在上一级目录里面查找。

# 文件系统实现

文件系统存放在磁盘上，如果磁盘分区，那每个分区都有一个独立的文件系统。分区后0号扇区称为**主引导记录（MBR）**，用来引导计算机，之后就是分区表，记录每个分区的起止位置。一般计算机被引导时，从BIOs读入执行MBR，确定一个活动分区，读入其第一个块**引导块**装载该分区中的操作系统。

文件系统实现的关键在于文件和目录的实现，即文件和目录是怎么存储的。

## 文件实现

文件存储实现的关键是记录各个文件用到哪些磁盘块，下面是一些常用方法：

- **连续分配：**每个文件作为一连串的数据块存储在磁盘上。其具有实现简单和读性能良好的特点，每个文件，目录项记录第一块磁盘地址和长度即可。对于缺点，不用说联想到先前的内存最早的分块管理，当删除一些文件后其肯定有**空洞**(零碎的空闲块)，如果维护一个空洞链表，那么分配文件位置时，必须知道文件最终大小。综上，其主要应用于提前知道文件大小的文件系统中，比如CD-ROM、DVD、蓝光光盘。

- **链表分配：**构造磁盘块链表，每一个块第一个字节作为指向下一块的指针，块的其他部分存放数据。这时可以充分利用碎片，目录项中只要存放第一块的磁盘地址即可。但是链表分配自然有链表的缺点，便于顺序访问但不便于随机访问，获取文件的块k复杂，此外一般，每个块的头部指针占据一定字节，数据部分就不是2的整数次幂，但许多程序每次读2的整数次幂大小的数据，所以会从两个磁盘块拼接信息，增加了复制的额外开销

- **利用内存中表进行内存分配：**将前面链表分配的指针字，放在内存中一个**文件分配表**中（FAT），示意图如下

  ![image-20201231111415581](/images/image-20201231111415581.png)

  当有连续块时，就可存放在连续块中，当连续块不够，就指向其余空闲的块中，这时目录项就只需要记录一个起始块号的整数。这样操作用于内存中操作快，一定提高了随机访问的速度，整个块都可以存放数据。缺点就是当块很小或者磁盘很大的时候，这个文件分配表很大，不再实用。

- **i节点：**就维护一个i节点的数据结构，其保存文件属性和文件所有块的磁盘地址，但是仅在打开文件时，才将其保存在内存中。这时只要估计每个文件有多少块，最多会打开多少文件，预留一固定大小空间即可。如果超过了i节点所能容纳的块数，可以考虑i节点最后一个地址执行一个包含额外磁盘块地址的地址。

## 目录实现

打开文件时，操作系统利用用户给出的路径名找到相应的**目录项**，目录项中提供了查找文件磁盘块中所需要的信息。

有的目录项还存储文件属性，但对采用i节点的系统，文件属性可以放在i节点中，目录项就只有文件名和i节点号。

**文件名变长问题**

由于文件名是变长的，如果固定一个最大值来固定文件名大小会浪费很大空间，毕竟不是每个文件会命长名。

另外一个想法是目录项大小不定，前面是长度固定的文件长度、文件属性等信息，后面接长度不定的文件名。但是显然当文件移走后，就会产生间隙，即和连续磁盘文件一样的问题，可能需要紧凑操作。此外目录项可能会分布在多个页面上，可能读取文件名时发生缺页中断。

此外，可以同上诉想法一样，使目录项有固定的长度，文件名放在目录后面的堆中，通过一个指针，指向该文件名，可以减少目录项中间隙问题，但还是有缺页中断。

**文件查询**

线性搜索目录速度比较慢，需要加速

- **高速缓存：**将查找结果放入高速缓存中，之后查找时，查看文件名是否在高速缓存中，以此定位，对目标集中的相对较小范围的文件集合有效
- **散列表：**散列表+拉链法的结构，管理复杂，预计文件目录过多时考虑

# 文件系统管理

## 磁盘空间管理

如前所述，磁盘管理文件存储有连续字节存储文件后分块存储两种策略，由于磁盘中移动操作比内存慢，所以一般是采用分块存储。

分块存储会带来以下问题：

- **块大小：**随着块的增大、空间利用率会下降而性能会上升，再结合文件大多是小文件，一般取1-4KB为块；但随着磁盘的增大，或许块增大接受浪费空间也可以。

- **空闲块管理：**为了实现文件存储分配，就需要对空闲块进行管理，类似于内存的分块管理，可以采用磁盘块链表和位图管理空闲磁盘空间。

  - 位图：一位表示一块是否空闲，占用空间小，大小固定
  - 磁盘块链表：链表中每个块记录尽可能多的空闲磁盘号，空间较大。如果改用链表记录连续空闲磁盘块时要看磁盘是否产生严重碎片才能发挥效果

  现在再来考虑其存储问题，一般就将其存储在空闲块上，一般就在内存中保持一个指针块（链表）或者就一个块（位图，由于位图固定大小，可以分页可以将其放在虚拟内存中，需要时调用）。

  对于链表的指针块，当文件创建时所需要块从指针块取，文件删除时，添入指针块，当这个块满时，可以写入磁盘，但是有时会增加不必要的磁盘I/O（写入磁盘后空闲块少，再新建文件可能又要读入磁盘指针块）；针对上诉问题，可以拆分满了的指针块，比如保持半满。

## 文件系统备份和一致性

**文件系统备份**

为了应对突发情况，需要对文件系统进行备份，一般有：

- **物理转储：**从磁盘第0块开始，全部磁盘块按序输出到磁带上
- **逻辑转储：**从一个或几个指定的目录开始，递归地转储其自给定自基准日期修改后的文件和目录。

前者简单快速，无法跳过指定目录，也无法增量转储，所以大多使用逻辑转储

**文件系统一致性**

如果文件系统读取磁盘块修改后，在全部写回磁盘前系统崩溃，则文件系统可能处于不一致状态。

这时候要保持文件系统一致性需要对**块**和**文件（目录系统）**进行一致性检测

前者检测块使用次数和在空闲链表或者位图的出现次数

对文件的一致性检测和链接有关



这部分的内容和**数据库恢复技术**有着联系，可以对照学习

## 文件系统性能

访问磁盘的速度比内存慢许多，文件系统对此进行优化改善性能

- **高速缓存：**高速缓存值逻辑上属于磁盘，实际保存在内存中的一系列块，当执行读操作时，先在高速缓存中检索，如果存在就指向读操作无需访问磁盘，如果不在，读到高速缓存再复制到其他地方。高速缓存之于磁盘正如硬件之于内存（比如块表的思想）。

  为了方便检索，常用方法会将设备和磁盘地址进行散列操作

  注意到其有更新高速缓存的操作，这就和页面调度算法类似，有类似的算法，选择不常用的块调出。由于对高速缓存的引用不频繁，可以考虑用链表实现LRU算法

  高速缓存还需注意一致性问题，可以将修改定时写入磁盘，或者只要是高速缓存中修改的立即写入磁盘，即**通写高速缓存**

- **块提前读：**当顺序读取文件时，可以提前将需要块读入高速缓存提高命中率。在不确定文件访问方式时，可以通过设置顺序访问方式位，一旦进行了查找，该位置0即可
- **减少磁盘臂运动：**将可能顺序访问的块放在一起，最好是一个柱面上，减少磁盘臂的移动次数。前面在FAT实现文件分配时，当有连续块时，就可存放在连续块中，当连续块不够，就指向其余空闲的块中就体现了这点。当然用位图很容易实现，空闲表稍微困难。