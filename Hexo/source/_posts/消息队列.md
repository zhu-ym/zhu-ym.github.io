---
title: 消息队列
typora-root-url: ../
date: 2021-05-19 16:23:06
tags:
- 消息队列
categories:
- [中间件]
---

主要是对消息队列的使用、可能出现的问题和常见的消息队列做一些概述

<!--more-->

# 消息模型

消息模型主要有两种模式，一种是点对点，一种是发布订阅

## 点对点

消息生产者向消息队列中发送了一个消息之后，只能被一个消费者消费一次。

## 发布订阅

消息生产者向频道发送一个消息之后，多个消费者可以从该频道订阅到这条消息并消费。

# 应用

消息队列主要有三种应用：**异步提高响应**、**高并发削峰限流**、**解耦**

## 异步提高响应

发送者将消息发送给消息队列之后，不需要同步等待消息接收者处理完毕，而是立即返回进行其它操作。消息接收者从消息队列中订阅消息之后异步处理。

比如淘宝提交订单后，后序可能会有短信通知，或者消费积分活动，这个过程可能用到了消息队列，首先保证了订单提交，然后将信息放入消息队列：短信通知，或者消费积分活动等其他流程业务异步进行

这样一个订单流程中可以缩减一些其他功能，提高响应速度

## 解耦

如果模块之间不直接进行调用，模块之间耦合度就会很低，那么修改一个模块或者新增一个模块对其它模块的影响会很小，从而实现可扩展性。

通过使用消息队列，一个模块只需要向消息队列中发送消息，其它模块可以选择性地从消息队列中订阅消息从而完成调用。

显然上诉的异步案例也是解耦案例，消息队列让订单和短信通知，或者消费积分活动等别的模块功能之间实现了解耦

## **高并发削峰限流**

在高并发的场景下，如果短时间有大量的请求到达会压垮服务器。

可以将请求发送到消息队列中，服务器按照其处理能力从消息队列中订阅消息进行处理。

一般在秒杀系统中可能涉及到对数据数据的操作，如果并发量过大，可能会造成数据库崩溃，可以将把请求放到队列里面，然后至于每秒消费多少请求，就看自己的服务器处理能力

# 问题

如果引入消息队列后，可能也会造成一些问题

## 重复消费

比如其他业务抛出异常后，利用**重试机制**要求消息重发而可能导致的重复消费问题

这样一般通过业务接口具有**幂等性**来解决，保证同样的参数调用接口，调用多少次结果都是一个

比如在下单系统中，做一个业务的流水表，每次消息过来都要拿着**订单号+业务场景这样的唯一标识**判断是否要走接下来的流程

## 消息丢失

如上，一般采用重试机制

具体的消息队列可能有不同的处理方法

## 消息消费顺序

主要是是**同个业务场景下不同几个操作的消息同时过去**，本身顺序是对的，但消费的时候却混乱

具体的消息队列可能有不同的处理方法

## 一致性问题

主要是指真正的消费者们，没有正确消费消息，造成的数据不一致。

一般可以用**分布式事务**解决

## 系统可用性问题

考虑到消息中间件可能挂掉的情况

# 常见消息队列

下图是常见消息队列的对比

![image-20210524161213694](/images/image-20210524161213694.png)

其中

**ActiveMQ：**没经过大规模吞吐量场景的验证，社区也不是很活跃，所以不推荐 **RabbitMQ：**活跃度高，**开源**，比较稳定的支持，推荐中小型公司使用，数据量较小

**RocketMQ：**阿里出品，Java语言编写，经过了阿里多年双十一大促的考验，性能和稳定性得到了充分的严重。目前在业界被广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binlog分发等场景

 **kafka：**大数据领域的实时计算、日志采集等场景，适合产生大量数据的互联网服务的数据收集业务

 